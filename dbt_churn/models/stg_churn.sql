{{ config(materialized='view') }}

SELECT 
    CUSTOMERID,
    UPPER(SURNAME) AS SURNAME,
    COALESCE(CREDITSCORE, 0) AS CREDITSCORE,
    GEOGRAPHY,
    GENDER,
    AGE,
    -- Faixa Etária
    CASE 
        WHEN AGE < 30 THEN '18-29'
        WHEN AGE BETWEEN 30 AND 39 THEN '30-39'
        WHEN AGE BETWEEN 40 AND 49 THEN '40-49'
        WHEN AGE BETWEEN 50 AND 59 THEN '50-59'
        ELSE '60+' 
    END AS FAIXA_ETARIA,
    CASE 
        WHEN AGE < 30 THEN 1
        WHEN AGE BETWEEN 30 AND 39 THEN 2
        WHEN AGE BETWEEN 40 AND 49 THEN 3
        WHEN AGE BETWEEN 50 AND 59 THEN 4
        ELSE 5 
    END AS ORDEM_FAIXA,
    CASE 
        WHEN COALESCE(BALANCE, 0) = 0 THEN 'Sem Saldo'
        WHEN BALANCE > 0 AND BALANCE <= 50000 THEN '0 - 50k'
        WHEN BALANCE > 50000 AND BALANCE <= 100000 THEN '50k - 100k'
        WHEN BALANCE > 100000 AND BALANCE <= 150000 THEN '100k - 150k'
        WHEN BALANCE > 150000 AND BALANCE <= 200000 THEN '150k - 200k'
        ELSE '200k+' 
    END AS FAIXA_SALDO,
    CASE 
        WHEN COALESCE(BALANCE, 0) = 0 THEN 1
        WHEN BALANCE > 0 AND BALANCE <= 50000 THEN 2
        WHEN BALANCE > 50000 AND BALANCE <= 100000 THEN 3
        WHEN BALANCE > 100000 AND BALANCE <= 150000 THEN 4
        WHEN BALANCE > 150000 AND BALANCE <= 200000 THEN 5
        ELSE 6 
    END AS ORDEM_SALDO,
    CASE 
        WHEN ESTIMATEDSALARY <= 50000 THEN 'Até 50k'
        WHEN ESTIMATEDSALARY > 50000 AND ESTIMATEDSALARY <= 100000 THEN '50k - 100k'
        WHEN ESTIMATEDSALARY > 100000 AND ESTIMATEDSALARY <= 150000 THEN '100k - 150k'
        ELSE '150k+' 
    END AS FAIXA_SALARIAL,
    CASE 
        WHEN ESTIMATEDSALARY <= 50000 THEN 1
        WHEN ESTIMATEDSALARY > 50000 AND ESTIMATEDSALARY <= 100000 THEN 2
        WHEN ESTIMATEDSALARY > 100000 AND ESTIMATEDSALARY <= 150000 THEN 3
        ELSE 4 
    END AS ORDEM_SALARIO_ESTIMADO,
    TENURE,
    COALESCE(BALANCE, 0) AS BALANCE,
    NUMOFPRODUCTS,
    HASCRCARD,
    ISACTIVEMEMBER,
    ESTIMATEDSALARY,
    EXITED AS IS_CHURN,
    CASE 
        WHEN EXITED = 1 THEN 'Cancelado'
        ELSE 'Ativo' 
    END AS CHURN_STATUS,
    DATA_CARGA
FROM {{ source('bronze', 'RAW_BANK_CHURN') }}